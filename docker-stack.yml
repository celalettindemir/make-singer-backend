version: "3.8"

# =============================================================================
# PORTAINER ENVIRONMENT VARIABLES (set in Portainer UI):
# -----------------------------------------------------------------------------
# DOCKER_USER              - Docker Hub username
# API_IMAGE                - API image name (default: make-singer-backend)
# AUDIO_IMAGE              - Audio image name (default: make-singer-audio)
# API_VERSION              - API image tag (default: latest)
# AUDIO_VERSION            - Audio image tag (default: latest)
# API_DOMAIN               - API domain (default: makesinger-api.celalettindemir.dev)
# REDIS_HOST               - Redis host (default: redis) → combined as REDIS_ADDR
# REDIS_PORT               - Redis port (default: 6379) → combined as REDIS_ADDR
# REDIS_PASSWORD            - Redis password (optional)
# POSTGRES_HOST            - PostgreSQL host (default: postgres)
# POSTGRES_PORT            - PostgreSQL port (default: 5432)
# POSTGRES_USER            - PostgreSQL admin/superuser (default: postgres)
# ZITADEL_EXTERNAL_DOMAIN  - External domain for Zitadel (e.g., auth.makeasinger.com)
# R2_BUCKET_NAME           - R2 bucket name (default: makeasinger)
# R2_PUBLIC_URL            - R2 CDN public URL
# GROQ_BASE_URL            - Groq API URL
# GROQ_MODEL               - Groq model
# SUNO_BASE_URL            - Suno API URL
# CORS_ORIGINS             - Allowed CORS origins (comma-separated)
# =============================================================================

services:
  # =============================================================================
  # API - Main Backend Service
  # =============================================================================
  api:
    image: ${DOCKER_USER}/${API_IMAGE:-make-singer-backend}:${API_VERSION:-latest}
    environment:
      SERVER_PORT: "8000"
      SERVER_ENV: production
      LOG_LEVEL: debug
      API_DOMAIN: ${API_DOMAIN:-makesinger-api.celalettindemir.dev}
      GATEWAY_ENABLED: "true"
      CORS_ORIGINS: ${CORS_ORIGINS:-}
      REDIS_ADDR: ${REDIS_HOST:-redis}:${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      GROQ_API_KEY_FILE: /run/secrets/groq_api_key
      GROQ_BASE_URL: ${GROQ_BASE_URL:-https://api.groq.com/openai/v1}
      GROQ_MODEL: ${GROQ_MODEL:-llama3-70b-8192}
      R2_ACCOUNT_ID_FILE: /run/secrets/r2_account_id
      R2_ACCESS_KEY_ID_FILE: /run/secrets/r2_access_key_id
      R2_SECRET_ACCESS_KEY_FILE: /run/secrets/r2_secret_access_key
      R2_BUCKET_NAME: ${R2_BUCKET_NAME:-makeasinger}
      R2_PUBLIC_URL: ${R2_PUBLIC_URL:-}
      ZITADEL_DOMAIN: ${ZITADEL_EXTERNAL_DOMAIN:-}
      ZITADEL_ISSUER: https://${ZITADEL_EXTERNAL_DOMAIN:-localhost}
      ZITADEL_CLIENT_ID_FILE: /run/secrets/zitadel_client_id
      SUNO_API_KEY_FILE: /run/secrets/suno_api_key
      SUNO_BASE_URL: ${SUNO_BASE_URL:-https://api.sunoapi.org}
      AUDIO_SERVICE_URL: http://audio-service:8084
      AUDIO_SERVICE_TIMEOUT: "120"
    secrets:
      - groq_api_key
      - r2_account_id
      - r2_access_key_id
      - r2_secret_access_key
      - suno_api_key
      - zitadel_client_id
    networks:
      - traefik-public
      - make-singer-backend
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=traefik-public"

        ## Middleware: ForwardAuth
        - "traefik.http.middlewares.ms-auth-forward.forwardauth.address=http://make-singer_api:8000/auth/verify"
        - "traefik.http.middlewares.ms-auth-forward.forwardauth.authResponseHeaders=X-User-Id,X-User-Email,X-User-Name"
        - "traefik.http.middlewares.ms-auth-forward.forwardauth.authRequestHeaders=Authorization,Cookie"

        ## Middleware: Rate Limit
        - "traefik.http.middlewares.ms-rate-limit.ratelimit.average=100"
        - "traefik.http.middlewares.ms-rate-limit.ratelimit.burst=200"
        - "traefik.http.middlewares.ms-rate-limit.ratelimit.period=1s"

        ## Middleware: Security Headers
        - "traefik.http.middlewares.ms-secure-headers.headers.browserxssfilter=true"
        - "traefik.http.middlewares.ms-secure-headers.headers.contenttypenosniff=true"
        - "traefik.http.middlewares.ms-secure-headers.headers.framedeny=true"
        - "traefik.http.middlewares.ms-secure-headers.headers.stsincludesubdomains=true"
        - "traefik.http.middlewares.ms-secure-headers.headers.stspreload=true"
        - "traefik.http.middlewares.ms-secure-headers.headers.stsseconds=31536000"
        - "traefik.http.middlewares.ms-secure-headers.headers.customframeoptionsvalue=SAMEORIGIN"

        ## Router: Protected API routes
        - "traefik.http.routers.ms-api-protected.rule=Host(`${API_DOMAIN:-makesinger-api.celalettindemir.dev}`) && PathPrefix(`/api`)"
        - "traefik.http.routers.ms-api-protected.entrypoints=web"
        - "traefik.http.routers.ms-api-protected.middlewares=ms-auth-forward@docker,ms-rate-limit@docker,ms-secure-headers@docker"
        - "traefik.http.routers.ms-api-protected.service=ms-api-svc"

        ## Router: Public routes (health, swagger)
        - "traefik.http.routers.ms-api-public.rule=Host(`${API_DOMAIN:-makesinger-api.celalettindemir.dev}`) && (Path(`/health`) || PathPrefix(`/swagger`) || Path(`/`))"
        - "traefik.http.routers.ms-api-public.entrypoints=web"
        - "traefik.http.routers.ms-api-public.middlewares=ms-secure-headers@docker"
        - "traefik.http.routers.ms-api-public.service=ms-api-svc"

        ## Router: WebSocket
        - "traefik.http.routers.ms-api-ws.rule=Host(`${API_DOMAIN:-makesinger-api.celalettindemir.dev}`) && PathPrefix(`/ws`)"
        - "traefik.http.routers.ms-api-ws.entrypoints=web"
        - "traefik.http.routers.ms-api-ws.service=ms-api-svc"

        ## Service
        - "traefik.http.services.ms-api-svc.loadbalancer.server.port=8000"
        - "traefik.http.services.ms-api-svc.loadbalancer.sticky.cookie=true"
        - "traefik.http.services.ms-api-svc.loadbalancer.sticky.cookie.name=ms_api_sticky"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # =============================================================================
  # AUDIO SERVICE - Audio Processing (Python/FFmpeg)
  # =============================================================================
  audio-service:
    image: ${DOCKER_USER}/${AUDIO_IMAGE:-make-singer-audio}:${AUDIO_VERSION:-latest}
    environment:
      LOG_LEVEL: debug
      R2_ACCOUNT_ID_FILE: /run/secrets/r2_account_id
      R2_ACCESS_KEY_ID_FILE: /run/secrets/r2_access_key_id
      R2_SECRET_ACCESS_KEY_FILE: /run/secrets/r2_secret_access_key
      R2_BUCKET_NAME: ${R2_BUCKET_NAME:-makeasinger}
      R2_PUBLIC_URL: ${R2_PUBLIC_URL:-}
    secrets:
      - r2_account_id
      - r2_access_key_id
      - r2_secret_access_key
    networks:
      - make-singer-backend
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
      labels:
        - "traefik.enable=false"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # =============================================================================
  # ZITADEL - Identity Provider (OIDC/OAuth2)
  # =============================================================================
  zitadel:
    image: ghcr.io/zitadel/zitadel:latest
    command: start-from-init --masterkeyFile /run/secrets/zitadel_masterkey
    user: "0"
    environment:
      # External access
      ZITADEL_EXTERNALDOMAIN: ${ZITADEL_EXTERNAL_DOMAIN}
      ZITADEL_EXTERNALSECURE: "true"
      ZITADEL_EXTERNALPORT: "443"
      ZITADEL_TLS_ENABLED: "false"
      # Database - admin user (PostgreSQL superuser, used only during init)
      ZITADEL_DATABASE_POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      ZITADEL_DATABASE_POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      ZITADEL_DATABASE_POSTGRES_DATABASE: zitadel
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: ${POSTGRES_USER:-postgres}
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: ${POSTGRES_PASSWORD}
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: disable
      # Database - runtime user (created by init, MUST differ from admin)
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: zitadel
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: ${ZITADEL_DB_PASSWORD}
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: disable
      # Connection pool (production tuning)
      ZITADEL_DATABASE_POSTGRES_MAXOPENCONNS: "20"
      ZITADEL_DATABASE_POSTGRES_MAXIDLECONNS: "10"
      ZITADEL_DATABASE_POSTGRES_MAXCONNLIFETIME: "30m"
      ZITADEL_DATABASE_POSTGRES_MAXCONNIDLETIME: "5m"
      # First instance setup (idempotent - skipped if already done)
      ZITADEL_FIRSTINSTANCE_LOGINCLIENTPATPATH: /data/login-client.pat
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: "false"
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_USERNAME: login-client
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_MACHINE_NAME: Login Client Service Account
      ZITADEL_FIRSTINSTANCE_ORG_LOGINCLIENT_PAT_EXPIRATIONDATE: "2030-01-01T00:00:00Z"
      ZITADEL_FIRSTINSTANCE_PATPATH: /data/admin.pat
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_USERNAME: admin
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_MACHINE_NAME: Admin Service Account
      ZITADEL_FIRSTINSTANCE_ORG_MACHINE_PAT_EXPIRATIONDATE: "2030-01-01T00:00:00Z"
      # Login v2
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_REQUIRED: "true"
      ZITADEL_DEFAULTINSTANCE_FEATURES_LOGINV2_BASEURI: https://${ZITADEL_EXTERNAL_DOMAIN}/ui/v2/login
      ZITADEL_OIDC_DEFAULTLOGINURLV2: https://${ZITADEL_EXTERNAL_DOMAIN}/ui/v2/login/login?authRequest=
      ZITADEL_OIDC_DEFAULTLOGOUTURLV2: https://${ZITADEL_EXTERNAL_DOMAIN}/ui/v2/login/logout?post_logout_redirect=
      ZITADEL_SAML_DEFAULTLOGINURLV2: https://${ZITADEL_EXTERNAL_DOMAIN}/ui/v2/login/login?samlRequest=
      # Logging (remove after initial setup is working)
      ZITADEL_LOG_LEVEL: debug
      ZITADEL_LOGSTORE_ACCESS_STDOUT_ENABLED: "true"
    secrets:
      - zitadel_masterkey
      - postgres_password
      - zitadel_db_password
    volumes:
      - zitadel_data:/data
    networks:
      - traefik-public
      - make-singer-backend
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 15s
        max_attempts: 10
      update_config:
        parallelism: 1
        delay: 30s
        order: stop-first
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "4.0"
          memory: 2G
        reservations:
          memory: 512M
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=traefik-public"

        ## Router: Zitadel catch-all (login UI gets higher priority)
        - "traefik.http.routers.ms-zitadel.rule=Host(`${ZITADEL_EXTERNAL_DOMAIN}`)"
        - "traefik.http.routers.ms-zitadel.entrypoints=web"
        - "traefik.http.routers.ms-zitadel.service=ms-zitadel-svc"
        - "traefik.http.routers.ms-zitadel.priority=10"

        ## Service: Zitadel
        - "traefik.http.services.ms-zitadel-svc.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "/app/zitadel", "ready"]
      interval: 10s
      timeout: 60s
      retries: 15
      start_period: 120s

  # =============================================================================
  # ZITADEL LOGIN - Login UI (Next.js)
  # =============================================================================
  zitadel-login:
    image: ghcr.io/zitadel/zitadel-login:latest
    user: "0"
    environment:
      ZITADEL_API_URL: http://zitadel:8080
      CUSTOM_REQUEST_HEADERS: Host:${ZITADEL_EXTERNAL_DOMAIN}
      NEXT_PUBLIC_BASE_PATH: /ui/v2/login
      ZITADEL_SERVICE_USER_TOKEN_FILE: /data/login-client.pat
    volumes:
      - zitadel_data:/data:ro
    networks:
      - traefik-public
      - make-singer-backend
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=traefik-public"

        ## Router: Zitadel Login UI (higher priority than zitadel catch-all /ui)
        - "traefik.http.routers.ms-zitadel-login.rule=Host(`${ZITADEL_EXTERNAL_DOMAIN}`) && PathPrefix(`/ui/v2/login`)"
        - "traefik.http.routers.ms-zitadel-login.entrypoints=web"
        - "traefik.http.routers.ms-zitadel-login.service=ms-zitadel-login-svc"
        - "traefik.http.routers.ms-zitadel-login.priority=200"

        ## Service: Zitadel Login
        - "traefik.http.services.ms-zitadel-login-svc.loadbalancer.server.port=3000"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  traefik-public:
    external: true
  make-singer-backend:
    external: true

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  zitadel_data:
    driver: local

# =============================================================================
# SECRETS - Create in Portainer: Secrets > Add secret
# =============================================================================
# API:    groq_api_key, suno_api_key, redis_password
# R2:     r2_account_id, r2_access_key_id, r2_secret_access_key
# Zitadel: zitadel_masterkey, zitadel_db_password, zitadel_client_id, postgres_password
# =============================================================================
secrets:
  groq_api_key:
    external: true
  suno_api_key:
    external: true
  redis_password:
    external: true
  r2_account_id:
    external: true
  r2_access_key_id:
    external: true
  r2_secret_access_key:
    external: true
  zitadel_masterkey:
    external: true
  zitadel_db_password:
    external: true
  zitadel_client_id:
    external: true
  postgres_password:
    external: true
